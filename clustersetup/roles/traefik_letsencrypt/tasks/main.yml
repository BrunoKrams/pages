---
- name: Fail if required variables are missing
  ansible.builtin.assert:
    that:
      - kubeconfig_path is defined
      - letsencrypt_email is defined
      - traefik_acme_resolver is defined
    fail_msg: "This role requires kubeconfig_path, letsencrypt_email, and traefik_acme_resolver to be passed!"

- name: Configure Traefik ACME (Letâ€™s Encrypt) in k3s
  kubernetes.core.k8s:
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        valuesContent: |
          additionalArguments:
            - "--certificatesresolvers.{{ traefik_acme_resolver }}.acme.email={{ letsencrypt_email }}"
            - "--certificatesresolvers.{{ traefik_acme_resolver }}.acme.storage=/data/acme.json"
            - "--certificatesresolvers.{{ traefik_acme_resolver }}.acme.httpchallenge.entrypoint=web"

- name: Restart Traefik to apply ACME config
  kubernetes.core.k8s:
    kind: Deployment
    namespace: kube-system
    name: traefik
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
    definition:
      spec:
        template:
          metadata:
            annotations:
              ansible-restarted-at: "{{ ansible_date_time.iso8601 }}"

- name: Wait for Traefik rollout to complete
  command: kubectl rollout status deploy/traefik -n kube-system --kubeconfig "{{ kubeconfig_path }}"
  changed_when: false
